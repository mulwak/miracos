; -------------------------------------------------------------------
;                 LINEGETTER インクルードライブラリ
; -------------------------------------------------------------------
; ファイルあるいはコンソール入力を1行ずつほしければ我をインクルードせよ
; -------------------------------------------------------------------

; -------------------------------------------------------------------
;                              定数宣言
; -------------------------------------------------------------------

; -------------------------------------------------------------------
;                             ZP変数領域
; -------------------------------------------------------------------
.ZEROPAGE
ZP_FD:          .RES 1          ; ファイル記述子。0に初期化されたままだとコンソールを指す。

; -------------------------------------------------------------------
;                              変数領域
; -------------------------------------------------------------------
.BSS
LINEBUFFER:     .RES 256
SECBF:          .RES 512

; -------------------------------------------------------------------
;                              実行領域
; -------------------------------------------------------------------
.CODE

; -------------------------------------------------------------------
;                             初期化処理
; -------------------------------------------------------------------
; ひとまずコンソールが使えるようになる
; -------------------------------------------------------------------
INIT:
  STZ ZP_FD                     ; コンソールに設定
  RTS

; -------------------------------------------------------------------
;                        ファイル記述子の設定
; -------------------------------------------------------------------
; ファイルからの入力に切り替わる
; -------------------------------------------------------------------
SET_FD:
  STA ZP_FD
  RTS

; -------------------------------------------------------------------
;                               行取得
; -------------------------------------------------------------------
GETLINE:
  LDA ZP_FD                     ; ファイル記述子のゼロチェック
  BNE EOF                       ; 非ゼロファイル用の処理に跳ぶ
  loadAY16 LINEBUFFER           ; バッファ位置
  syscall CON_IN_STR            ; キーボード入力を受ける
  CLC
  RTS
EOF:
  ; ファイル終端を通知する
  SEC
  RTS

